---
title: 'Clase 2: Comisarías y Trabajo práctico LaLonde (1996)'
author: "Arturo Maldonado"
date: "29/3/2022"
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: false
    toc_depth: 1
    code_download: true
    theme: cosmo
    highlight: textmate
editor_options:
  markdown:
    wrap: sentence
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

------------------------------------------------------------------------

# Medidas de tendencia central

-   Resumen de un conjunto de datos.

-   Se resume mediante un valor "representativo".

-   Cada observación se puede comparar con este valor de resumen.
    Se puede estar por debajo o por encima de este valor.

------------------------------------------------------------------------

## Moda

-   Valor mas frecuente de un conjunto de datos

-   Es apropiada para todo tipo de datos

-   Se puede observar directamente en una tabla de distribución de frecuencias.

Por ejemplo si se mide en cada comisaria del Perú, a cuánta población atiende cada comisaria de acuerdo a la codificación.

![](comi17_pob.png){width="734"}

La base de datos o "dataframe" se vería así

![](comi17_pob2.png)

------------------------------------------------------------------------

Para esta clase se usará la base de datos de comisarias del Perú, que puede ser descargada de la sección microdatos de la web del INEI (ver [aquí](http://iinei.inei.gob.pe/microdatos/)).
Esta base tiene información para 1495 comisarias y de 281 variables.
Esta base se puede cargar también desde el repositorio Github de este curso.
La base de datos puede ser guardada en el directorio de trabajo.

En primer lugar, se llama a la librería "rio" y se usa el comando `import` que permite leer bases de datos en muchos formatos.

```{r base}
library(rio) 
comi17 = import("bases/comi2017.sav")
```

Esta base de datos incluye a la variable "INF109" (ojo: R es "case sensitive", es decir, diferencia mayúsculas de minúsculas).
La tabla de distribución de frecuencias de esa variable se puede obtener con el comando `table.`

```{r tabla}
table(comi17$INF109)
```

En este caso, la moda es el valor más frecuente, que sería el código "2", que significa "De 5,000 a 10,000 hab".

## Mediana

-   El valor de la observación central de un conjunto de datos ordenados de menor a mayor.

![](mediana1.png){width="497"}

![](mediana2.png){width="498"}

Para calcular la mediana de la variable "INF109" se puede usar el comando `median`.
Este comando internamente ordena los valores de la variable "INF109" de menor a mayor y encuentra el código numérico de la observación que se encuentra en medio de la distribución ordenada.

```{r}
median(comi17$INF109)
```

La mediana es el código numérico 3, que significa "De 10,001 a 20,000 hab.".

------------------------------------------------------------------------

## Media

-   Medida más conocida y "útil".

-   Suma del valor de las observaciones dividida entre el número de observaciones

$$
\sum \frac{x_i} {n} = \frac{(x_1 + x_2 +x_3 +...+ x_n)} {n}
$$

En una base de datos, se puede calcular la media sumando los valores de una variable (columna de una base de datos) y dividiendo entre el número de casos (# total de filas).

![](comi17_media.png){width="258"}

------------------------------------------------------------------------

## Resumen

| TC      | Nominales | Ordinales | Numéricas |
|---------|:---------:|:---------:|:---------:|
| Moda    |    Sí     |    Sí     |    Sí     |
| Mediana |    No     |    Sí     |    Sí     |
| Media   |    No     |    No     |    Sí     |

-   Moda aplica para cualquier tipo de variable, pero menos útil.

-   Media aplica solo para variables numéricas, pero más útil.

------------------------------------------------------------------------

## Ejemplo

¿Cuál es la media (o el promedio) de policías por comisaria de acuerdo a estos datos?

```{r media}
mean(comi17$INF110_TOT)
```

¿Es una representación adecuada de la realidad?
Podemos fijarnos en el gráfico de distribución de esta variable para ver si se tiene comisarias que son "atípicas" de la distribución general.

Esto se puede hacer presentando el histograma de esta variable, que es como un gráfico de barras de una variable numérica.

```{r hist}
hist(comi17$INF110_TOT, breaks=20)
```

¿Qué se puede concluir del gráfico?

```{r mediana}
median(comi17$INF110_TOT)
```

¿Qué significa esta diferencia entre la media de 31.6 y la mediana de 19?

```{r resumen}
summary(comi17$INF110_TOT)
```

¿Qué se puede comentar de estos datos?

# Medidas de dispersión

-   Describir la centralidad no es suficiente.
    Dos distribuciones pueden tener la misma medida de tendencia central, pero diferentes realidades.

-   Ejemplo: distribución de puntaje en área matemática de prueba PISA aplicada en 2 países pueden tener la misma media, pero diferente variación.

-   ¿Cómo describiría las diferencias entre en los puntajes de la prueba el País A y el País B?

![](distr.png){width="631"}

------------------------------------------------------------------------

## Rango

-   Diferencia entre el valor máximo y el mínimo.
    En ejemplo de policías: 259-3 = 256.
    Es la diferencia entre la comisaría con más efectivos y la comisaría con menor número de efectivos.

-   No un una medida muy útil.

------------------------------------------------------------------------

## Rango intercuartil

-   Se verá cuando se vean percentiles.

------------------------------------------------------------------------

## Desviación estándar

-   Cada observación está a una "distancia" de la media.
    Esta distancia se llama desviación $(x_i-\bar{x})$

-   Observaciones por encima de la media tendrán desviaciones positivas.
    Observaciones por debajo de la media tendrán desviaciones negativas.

-   No se puede calcular un promedio de desviaciones porque valores positivos se cancelan con negativos.

-   Se eleva al cuadrado las observaciones para que todas sean positivas.
    Se promedian esas desviaciones al cuadrado.

-   La desviación estándar es la raíz cuadrada de ese promedio de desviaciones al cuadrado.

-   Se divide entre n-1 por un tema técnico.

$$
\sum \frac{(x_i-\bar{x})^2} {n-1} 
$$

Para ver un cálculo básico de la desviación estándar en Excel, puede entrar [aquí](https://docs.google.com/spreadsheets/d/1CCzOtfXf7Igz_KcbcpItzU71fWeMtTli?rtpof=true&authuser=arturo.maldonado%40pucp.pe&usp=drive_fs).

-   Como se observa en el gráfico anterior, la desviación estándar es más útil cuando se comparar dos distribuciones. Se compara la centralidad y la dispersión de una variable entre dos grupos (o dos distribuciones).

## Ejemplo

Siguiendo con la base de datos de comisarías del Perú, queremos evaluar si el número de policías (INF110_TOT) aumenta a medida que la comisaría atienda a una población mayor (INF109).

Como se vio antes, la variable de población a la que atiende está codificada en 6 grupos, desde 1 que significa "Menos de 5000 hab" a 6 que significa "De 80000 a más hab".

```{r tablapob}
table(comi17$INF109)
```

Lo que se quiere calcular es el promedio y la desviación estándar de policías por cada grupo de población a la que atiende.
Esta operación se puede hacer de múltiples maneras en R.
Aquí usaremos primero los `[…]` para indicar un subgrupo del que se quiere calcular alguna operación.

```{r mediagrupos}
mean(comi17$INF110_TOT[comi17$INF109==1])
mean(comi17$INF110_TOT[comi17$INF109==2])
mean(comi17$INF110_TOT[comi17$INF109==3])
mean(comi17$INF110_TOT[comi17$INF109==4])
mean(comi17$INF110_TOT[comi17$INF109==5])
mean(comi17$INF110_TOT[comi17$INF109==6])
```

Efectivamente, como se esperaba, el número promedio de policías aumenta a medida que la comisaría atiende a una población mayor.

También se puede comparar la desviación estándar en cada grupo.
El comando para el cálculo de la desviación estándar es `sd`.

```{r desvgrupos}
sd(comi17$INF110_TOT[comi17$INF109==1])
sd(comi17$INF110_TOT[comi17$INF109==2])
sd(comi17$INF110_TOT[comi17$INF109==3])
sd(comi17$INF110_TOT[comi17$INF109==4])
sd(comi17$INF110_TOT[comi17$INF109==5])
sd(comi17$INF110_TOT[comi17$INF109==6])
```

La desviación estándar también aumenta a medida que las comisarías atienden a una población mayor.
Es decir, las comisarías que atienden a una población pequeña son más homogéneas que las que atienden a una población mayor, donde hay mayores diferencias en el número de efectivos entre comisarías.

¿A qué puede deberse este resultado?
Una posible explicación es la complejidad de ciudades más grandes, por lo que podría requerir comisarias especializadas, además de las comisarias estándar.
Por el contrario, centros urbanos más pequeños solo requerirían comisarías pequeñas.

En R hay diferentes maneras de hacer lo mismo.
Para los gráficos existe una librería especializada llamada `ggplot2`.
Con esa librería se tiene más opciones gráficas que con los comandos de base.
También existe una forma de codificación llamado `tidyverse` que usa el operador `%>%`.
Aquí se presenta un ejemplo que produce el histograma del número de policías por cada grupo de tamaño de población.

```{r histgrupos}
library(ggplot2)
library(dplyr)
comi17 %>%
  ggplot(aes(x=INF110_TOT))+
  geom_histogram()+
  facet_wrap(~INF109)+
  xlab("Número de policías")+
  ylab("Frecuencia")
```

¿Qué otras preguntas se pueden responder con los datos de comisarías?

------------------------------------------------------------------------

# Paper práctico

"Evaluating the Econometric Evaluations of Training Programs with Experimental Data" [@lalondeEvaluatingEconometricEvaluations1986]

Pregunta: ¿tiene un efecto los programas de entrenamiento en la empleabilidad?

Supuesto: entrenando a trabajadores que no tienen las habilidades básicas hará que se muevan en el mercado laboral, dándoles experiencia laboral y consejería.
Se trata de un programa estatal que garantiza un trabajo entre 9 a 18 meses.
Luego de este periodo eran forzados a encontrar un trabajo regular.

Metodología: evaluación experimental.
Un grupo fue parte del programa.
Otro grupo comparable no fue parte del programa.
Se recolectó una línea de base con información de ingresos y datos sociodemográficos.
Luego se hizo recojo de información de seguimiento.

Variable de éxito: cambio en los ingresos.

------------------------------------------------------------------------

# Leyendo la base de datos en R

```{r base2}
library(rio)
LL <- import("bases/LL.csv")
```

------------------------------------------------------------------------

# Variables en la base de datos

-   treated: variable dummy si el participante recibió el tratamiento (1) o no (0)
-   age: edad
-   education: años de educación
-   black: variable dummy si el participante es Afroamericano
-   married: variable dummy si el participante es casado
-   nodegree: variable dummy de no tener estudios secundarios completos (high school)
-   re74: ingresos reales en 1974
-   re75: ingresos reales en 1975
-   re78: ingresos reales en 1978
-   hispanic: variable dummy si el participantes es hispano
-   u74: variable dummy si era desempleado en 1974
-   u75: variable dummy si era desempleado en 1975

------------------------------------------------------------------------

# Medidas de tendencia central

## Media

¿Cual es la media de ingresos de los participantes antes de entrar al estudio?
Ojo que algunos de ellos pueden haber entrado al programa y otros ser parte del grupo de comparación.

```{r ingresos74}
mean(LL$re74)
```

Aparentemente, el ingreso de los participantes del estudio en la línea de base es bastante bueno.
Pero, es necesario hacer ver si ese dato refleja la "realidad" de los ingresos del conjunto de participantes del estudio.
Una manera de analizar eso, es ver la distribución de respuestas de forma gráfica, por ejemplo, usando un histograma.
En este gráfico, además, se puede incluir una línea que marque el punto de la media.

```{r hist74}
hist(LL$re74)
abline(v=mean(LL$re74), col="red")
```

Como se observa, la distribución de esta variable está sesgada hacia los valores altos de la variable.
¿Qué pasa con la media en estas situaciones?

## Mediana

Para estos casos, se tiene otra medida de tendencia central, la mediana.
La mediana es el punto medio de un conjunto de datos ordenados.
Por ejemplo, si tengo 5 personas con los siguientes ingresos ordenados: 800, 1200, 1500, 3000, 5000.
La mediana es el ingreso de la persona que está al medio de la fila ordenada, es decir, la persona en la posición 3.
La mediana sería 1500 soles.
La media de estas 5 observaciones sería 2300 soles.
Si se quisiera "encontrar" la mediana en la base de datos, ¿qué se debería hacer?
¿Si son 722 observaciones, cuál es el punto medio?

La fila sería de observación 1.....411 / 412......822 La mediana sería el promedio simple del valor del ingreso que tiene la persona ubicada en la posición 411 (823.2544) y del de la posición 412 (824.3886).

Para calcular la mediana del grupo del estudio, se usa.

```{r mediana74}
median(LL$re74)
```

Como se observa la mediana es mucho menor que la media y, en este caso, es un mejor resumen de la "realidad" del conjunto de ingresos de los participantes en este estudio.

¿Qué pasa si en mi ejemplo de la fila, la última persona que gana 5000 recibe un súper aumento y pasa a ganar 15000 soles.
¿Cambia la media?
¿Cambia la mediana?

## Resumen de una variable

Si se quisiera ver la media y la mediana con un solo comando, se puede usar `summary`.

```{r resumen74}
summary(LL$re74)
```

Se observa claramente que la media es mucho mayor que la mediana.
¿Qué significa que el Min=0?
¿Qué significa 1st Qu = 0?
¿Median a qué porcentaje corresponde?
¿3rd Qu a qué porcentaje corresponde?
¿Qué significa Max?
¿Máximo observado puede ser atípico?

Para observar la posición relativa de media y mediana, se puede graficar el histograma marcando ambas medidas.

```{r hist74_2}
hist(LL$re74, breaks = 15)
abline(v=mean(LL$re74), col="red")
abline(v=median(LL$re74), col="blue")
```

Con el comando `summary` se puede ver que la mediana aparece como un caso particular de los cuartiles, una medida de posición.

------------------------------------------------------------------------

## Medidas de posición

Los cuartiles dividen a la distribución en cuatro grupos de igual tamaño.
Así como la mediana divide a la "fila ordenada" en 2 grupos, cada uno con 411 observaciones, los cuartiles dividen la distribución en 4 grupos, cada uno con el 25% del total de observaciones (180.5 observaciones).

Los cuartiles son las medidas de posición más usadas, pues tienen una expresión gráfica en el "boxplot".
Sin embargo, una distribución ordenada se puede dividir en tres grupos iguales, los "terciles".
Por ejemplo, en la universidad, a los alumnos se los clasifica en tercio superior, tercio medio y tercio inferior.

Una distribución ordenada también puede ser dividida en cinco grupos, los "quintiles" o en diez grupos iguales, los "deciles".

```{r cuartiles}
quantile(LL$re74)
quantile(LL$re74, c(0,.1,.2,.3,.4,.5,.6,.7,.8,.9,1))
```

## Gráfico de cajas

Una forma de graficar los cuartiles es mediante el gráfico de cajas o boxplot (ver ppt).
Este gráfico muestra una caja central y dos bigotes.
El gráfico para la variable ingresos de la línea de base es:

```{r caja}
boxplot(LL$re74)
```

¿Por qué no se muestra el bigote inferior?
¿Qué significan los puntos superiores?

------------------------------------------------------------------------

## Tablas de frecuencias

El ingreso descrito anteriormente es para toda la muestra.
El estudio, sin embargo, dividió a los participantes en 2 grupos: tratados y control.
¿Cuántos hay en cada grupo?

```{r tablatrat}
table(LL$treated)
```

La línea de base también recogió información sociodemográfica de los participantes.
En particular, nos interesa saber cuántos afroamericanos hay en el grupo.

```{r tablaafro}
table(LL$black)
barplot(table(LL$black))
```

Y sobre todo saber qué nivel educativo tienen.

```{r tablaeduc}
table(LL$education)
```

Las frecuencias absolutas no nos ayudan mucho, es mejor tener las frecuencias relativas.

```{r propeduc}
table(LL$education)/sum(table(LL$education))*100
```

O, se puede usar el comando `prop.table` que nos da la proporción (en escala 0-1).
Para reportar el porcentaje se multiplica por 100.

```{r propeduc_2}
prop.table(table(LL$education))*100
```

Esta variable se podría considerar como numérica, por lo que se podría describir.

```{r resumeneduc}
summary(LL$education)
```

Y se podría graficar

```{r cajaeduc}
boxplot(LL$education)
```

O con un histograma (un gráfico de barras de una variable numérica).

```{r histeduc}
hist(LL$education)
```

O mediante

```{r histeduc_2}
barplot(table(LL$education),xlab="Años de educación",ylab="Frecuencia",cex.axis=1,cex.names=0.8,ylim=c(0,200))
abline(h=0,col='gray60')
box()
```

------------------------------------------------------------------------

# Medidas de dispersión

## Rango intercuartil

Distancia entre Q3 y Q1, que acumula el 50% de los datos centrales.

```{r iqr74}
IQR(LL$re74)
```

Para una variable numérica, la medida más usada es la desviación estándar.

```{r desv74}
sd(LL$re74)
```

RETO: Calcule una medida de dispersión basada en la mediana

------------------------------------------------------------------------

# Inspeccionando la hipótesis de LaLonde

Hasta ahora se ha calculado la media de ingresos para el total de los participantes del estudio en 1974.
La idea es analizar cómo cambiaron estos ingresos entre 1974 y 1978 para cada grupo.
Para empezar, ¿cómo eran los ingresos de los participantes que fueron tratados y que fueron al grupo control al inicio del estudio?
Para esto se tiene que calcular la media para cada uno de estos grupos.
Hay varias maneras de hacer esto.
Una es usando los \[\]

```{r ll}
mean(LL$re74[LL$treated==0])
sd(LL$re74[LL$treated==0])

mean(LL$re74[LL$treated==1])
sd(LL$re74[LL$treated==1])
```

Otra opción es creando otros "dataframes" para cada grupo con el comando `subset`.

```{r llsubset}
trata <- subset(LL, LL$treated==1)
control <- subset(LL, LL$treated==0)
```

Y en cada subgrupo calcular la media.
En este caso calcularemos la media en 1978 para ver si se generaron diferencias.

```{r mediall}
mean(control$re78)
sd(control$re78)

mean(trata$re78)
sd(trata$re78)
```

A simple vista, ¿se cumple la hipótesis de LaLonde?
¿Con esta información es suficiente para concluir que se cumple la hipótesis de LaLonde?

Es posible que la media sea mayor en el grupo de tratamiento debido a los valores extremos o "outliers".
Para verificar que el grupo de tratamiento reporta un ingreso mayor que el grupo control, se puede verificar mediante la mediana.

Para comparar visualmente, los ingresos en 1978 entre los participantes en el grupo control y en el de tratamiento, se puede hacer un gráfico de cajas comparada, que incluye la mediana.

Este gráfico se puede hacer con el comando `boxplot`, incluyendo ambas variables en la definición.

```{r cajacomp}
boxplot(LL$re78 ~ LL$treated, ylim=c(0, 24000))

```

Este gráfico no se muestra claramente las diferencias entre los valores de la mediana.
Cuando se calculan, se observa que el grupo de tratamiento tiene una mediana de ingresos más alta que el grupo control.

```{r mediana comparacion}
median(control$re78)
median(trata$re78)
```

Esta diferencia a a favor de aquellos que pasaron el programa de capacitación en sus ingresos posteriores puede deberse a múltiples factores.
Sin embargo, es apresurado sacar una conclusión de las diferencias puntuales en las medias o las medianas.
Al final, no se tiene información de toda la población, sino simplemente de una muestra de 722 personas.

La pregunta es: ¿se puede extraer conclusiones acerca de la población de trabajadores que no tienen las habilidades básicas sobre la base de estas 722 observaciones?

Para una opción más interactiva se puede usar el paquete `plotly` para graficar ambas cajas y que se muestren los valores.

```{r message=FALSE, warning=FALSE}
library(plotly)
plot <- plot_ly(LL, y=~re78, color=~as.factor(treated), type="box", boxpoints = "all", 
                jitter = 0.4, pointpos = -1.8) %>% layout(title ="Ingresos 1978 por Grupo",
                                                          xaxis = list(title = "Grupos",
                                                                      showgrid = F),
                                                          yaxis = list(title ="Ingresos 1978",
                                                                       showgrid = F))
                                    
plot
```

------------------------------------------------------------------------

# Bibliografía
